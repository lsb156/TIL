# 03. 마이크로 서비스 디자인
도메인 주도 디자인 DDD 방식으로 MSA 적용하는것이 매우 중요

DDD의 핵심 원리 중 하나는 분할 및 정복 (divide and conquer)

## Event Driven 
이벤트를 사용한 서비스 간 통신은 서비스 간 통신에서 일반적으로 사용되는 패턴 중 하나.

Event Driven 은 종종 분산 처리 시스템과 연결되어 언급

분산 처리 시스템에 Event Driven을 엮어 느슨한 결합을 지원하고 유연성, 탄력성, 확장성 있는 시스템을 구현

### EDM (Event Driven MicroService)
- Event Driven MicroService(EDM)에서는 발생된 이벤트는 반드시 보관되어야함
- 보관된 이벤트는 데이터의 현재 상태를 구성하는 근간이 됨
- 또한, 보관된 이벤트를 바탕으로 장애 발생 또는 특정 요구사항에 따라 지정된 시점으로 복원을 수행
- 이벤트 로그를 보관하는 장소를 이벤트 스토어라 칭함 (ex. Kafka)

> https://medium.com/dtevangelist/event-driven-microservice-%EB%9E%80-54b4eaf7cc4a

## 유비쿼터스 언어
유비쿼터스 언어는 도메인 전문가와 개발자가 서로 공유하는 공유 팀 언어

유비쿼터스는 대화에서 코드까지 어느곳에나 사용되어야함. (실제로는 바운디드 컨택스트 내부에 한해서 사용)

그 이유는 도메인 전문가와 개발자 간의 의사 소통에서 갭을 메워주고 같은 해석을 하게끔 도와줌

소프트웨어 디자인에서 도메인 전문가가 관여하는 단계는 요구 사항 수집 단계에서만 관여한다.

비즈니스 분석가(BA business analyst)는 기술 요구 사항을 포함한 사양으로 변환하여 도메인 전문가와 개발자가 모두 충분히 이해할 수 있는 도메인 모델을 구축

## 바운디드 컨텍스트
MSA에서 가장 중요한것은 서비스의 범위를 지정하는 것
SOA에서는 각각의 도메인을 별도의 서비스로 생각하지 않고 하나의 시스템으로 취급
그렇게 모놀리틱 어플리케이션이 생겨나게되어 관리가 힘들어진다.

MSA를 각각의 마이크로서비스로 범위를 나누는데는 바운디드 컨텍스트로 나뉜다.

바운디드 컨텍스트는 마이크로서비스 디자인의 핵심 요소.

각각의 바운디드 컨텍스트는 다른 컨텍스트와 어떤 모델을 공유 할지 정의하는 명시적인 인터페이스를 가진다.

하나의 도메인이라고 하나의 마이크로 서비스를 가지는건 아니고 여러개의 서비스가 존재 가능

도메인 전문가와 긴밀하게 협업하여 기업 내에서 도메인이 어떻게 동작하는지 정확하게 이해해야한다.

### 역할별 예시
- 주문 처리 
    - 주문 처리 기능 캡슐화
    - 재고 목록의 주문 잠금, 고객 주문에 대한 기록
- 재고
    - 공급 업체로부터 물품을 수령하고 배송을 위해 출하할 때 재고를 업데이트
- 공급자 관리 
    - 공급자 관리 관련 기능을 캡슐화
    - 배송품목을 release 할때 재고 보유량이 충분한지 확인
    - 재고가 충분하지 않을 경우 해당 공급 업체에 통보
    
#### 처리 순서
1. 주문 
    1. `주문`에서 `재고`를 업데이트 
    2. `주문`에서 주문 항목을 잠금
    3. 주문을 배송 준비중으로 변경 
    4. `주문`에서 `ORDER_PROCESSING_COMPLETED` 이벤트 발생
2. 청구
    1. `ORDER_PROCESSING_COMPLETED` 이벤트 수신
    2. 지불 처리 실행
    3. `PAYMENT_PROCESSING_COMPLETED` 이벤트 발생
3. 공급업체관리 
    1. `PAYMENT_PROCESSING_COMPLETED` 이벤트 수신
    2. 재고 항목 수가 최소 임계값을 초과하는지 확인
    3. 부족한 경우 공급 업체에 통지
4. 배달 
    1. `PAYMENT_PROCESSING_COMPLETED` 이벤트 수신
    2. 항목들을 그룹화 하여 주문을 작성 후 배달 준비
    3. `ORDER_DISPATCHED` 이벤트 발생
5. 주문 
    1. `ORDER_DISPATCHED` 이벤트 수신
    2. 주문 상태 배송중으로 업데이트
    
위에 단계처럼 잘 정의된 인터페이스 뒤에 비즈니스 로직이 캡슐화 되면 새로운 변경이 전체 시스템에 영향을 미치지 않음.

마이크로 서비스 간 통신하는 이벤트를 `도메인 이벤트` 라고 명칭

## 컨텍스트 맵

## 관계형 패턴

### 손상 방지 계층
### 공유 커널
### 순응자
### 고객 공급자
### 파트너쉽
### 공표된 언어
### 개방형 호스트 서비스
### 서로다른 길
### 진흙투성이 큰 공
