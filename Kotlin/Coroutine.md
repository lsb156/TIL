# Coroutine

## Coroutine이란?
코루틴은 다음과 같은 형태를 가지고 있습니다.
- 비선점형 멀티태스킹(non-preemptive)의 서브루틴(subroutine) 형태
- 지연(suspend)과 재개(resume)가 가능한 형태의 작업
- 협력형(cooperative) 태스크와 비슷하게 동작

> **지연**
> 무엇인가를 하고있다가 잠시 물러나있는 상태
>
> **재개**
> 물러나있다가 다시 올라오는 형태
>
> **비선점형 멀티태스킹**
> OS Scheduler가 CPU에 작업을 일시중단시키고 다른 작업을 CPU에 작업시키는 것을 선점형이라 불리우고 CPU에서 하는 Scheduler 작업을 중단 시키지 않고 라이브러리형태가 협력적으로 계속 유지시켜주는것을 비선점형 이라고 불리운다.
>
> **Task**
> Process (독립된 메모리, 스택), Thread (공유 메모리, 독립 스택) 를 합쳐서 부르는 말

코루틴을 사용해 특정 루틴의 브로킹을 분리하고 비동기적으로 협력형 멀티태스크를 구현할 수 있게 된다.
이러한 작업들은 OS 스케쥴러가 아닌 코루틴 라이브러리에서 작동하게 된다.
위와 같은 이유로 코루틴은 Context Switching에 대한 오버헤드가 없다.

> **협력형 멀티태스크**
> 다수의 루틴을 정해진 규칙에 다라 실행 시간을 나눠 갖는 것
> 하나의 루틴은 자발적으로 지연(suspend)하거나 중단(stop) 할 수 있다.
>
> **비동기**
> 두개의 Task가 동시에 수행되는것처럼 보이는것 (실제로는 변갈아가면서 실행이된다.)
> 순차적 실행과는 협력적이거나 병행적으로 실행 됨
>
> **블로킹**
> 현재 수행되는 루틴이 다른 요소에 의해 실행이 중단되고 잠시 물러나게 되는 상태

## 프로세스, 코루틴과 스레드
### 프로세스
- 프로세스는 실행중인 애플리케이션의 인스턴스.
- 프로세스는 상태를 가지고 있다.
- 리소스를 여는 핸들, 프로세스 ID, Data, Network 연결등은 프로세스 상태의 일부 (내부의 스레드가 엑세스 가능)
- 하나의 어플리케이션에는 여러개의 프로세스로 구성

### 스레드
- 개수에 따라 완전히 **병행형으로 동작**할 수 있음
- OS의 스케쥴러가 실행 시점을 결정함 (스케쥴러가 선점할 수 있음)
- **선점형 멀티태스크**, 멀티프로세싱, **병행성**(Parallelism) 제공
- 스레드별 **독립적인 스택**을 가지게 됨
- 스레드 로컬 스토리지라는 개별적인 저장소를 가지고 있다.

스레드 안에서 명령은 한 번에 하나씩 실행돼 스레드가 블록되면 블록이 끝날때까지 같은 스레드에서 다른 명령을 실행할 수 없다.

### 코루틴
- 기본 옵션으로 **협력형**이며 병행형으로 동작하지 않음 (옵션 조절이 가능)
- 스케쥴러가 실행시점을 결정하는 것이 아닌 프로그래머나 이벤트에 의해 실행 및 지연(Suspend), 재개(Resume) 시점이 결정됨
- **비선점형 멀티태스크**, **동시성**(Concurrency) 제공
- 독립적 스택을 가질 수도 있으나 일반적으로 **스택을 다시 생성하지 않음** (때에따라서 독립적으로 스택 풀을 생성)
스레드 하나에 많은 코루틴이 들어갈 수 있지만 주어진 시간에 하나의 스레드에서 하나의 명령어만이 실행


## 동시성과 병령의 차이점
동시성은 하나의 프로세스 유닛을 통하여 두가지 스레드중에 하나만 처리하는 방식이다.
싱글코어가 여러개의 스레드를 실행한다고 생각하면 쉽게 이해가 된다. (싱글스레드는 여러개 스레드르 동시에 실행하지 못함)
다만 병렬처리는 두개 이상의 프로세스 유닛을 사용해 각각 독립적인 스레드를 실행하는 동시성 코드르 병렬로 실행한 것
두개의 스레드가 실행되는 타임라인이 겹치면 병렬이고 겹치지 않고 동시에 하나의 스레드만 실행이 되고있다면 동시성이다.
병렬은 동시성이지만 동시성은 병렬성이 없이도 발생할 수 있다.




## 코루틴의 개념 요소
### Coroutine Scope
코루틴 문맥을 실행하기 위한 제한 범위를 지정

### Coroutine Context
코루틴을 실행하는 문맥으로 특정 실행 환경을 결정

### Coroutine Builder
CoroutineScope에서 실행할 코루틴을 지정하고 생성
- launch
- async

### CoroutineDispatcher
코루틴의 실행 방식을 담당
#### Dispatchers.Default
기본 디스패처로서 스레드풀(Thread Pool)을 사용해 실행
#### Dispatchers.Main
메인 스레드를 사용해 실행
#### Dispatchers.IO
긴 시간을 실행하는 I/O 작업을 위해 준비된 스레드 사용
#### Dispatchers.Unconfined
지연 / 재개시 특정 스레드로 분리될 수 있다. (코드에서는 보통 사용하지 않음)

